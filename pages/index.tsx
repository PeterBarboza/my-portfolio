import { useCallback, useEffect, useState } from "react"
import type { NextPage } from "next"
import Head from "next/head"

import { Layout } from "../components/Layout"
import { About } from "../components/About"
import { Header } from "../components/Header"
import { ProjectsSection } from "../components/ProjectsSection"
import { TextCard } from "../components/TextCard"
import { Footer } from "../components/Footer"
import { StudiesSection } from "../components/StudiesSection"

import { irbano } from "../assets/texts/irbano"

type githubrepository = {
  name: string
  html_url: string
  description?: string
  created_at: string
  homepage?: string
  tags_url?: string
  owner: {
    login: string
  }
}

type repositoryTagsObject = {
  name: string
  zipball_url: string
  tarball_url: string
  commit: {
    sha: string
    url: string
  },
  node_id: string
}

type repositoryTagsResponse = repositoryTagsObject[]

const Home: NextPage = () => {
  const [repos, setRepos] = useState<githubrepository[]>([])
  const [isHidden, setIsHidden] = useState<boolean>(true)
  const githubUrl = process.env.NEXT_PUBLIC_GITHUB_URL || "https://api.github.com/users/peterbarboza/repos"

  const getRepos = useCallback(async () => {
    function sortMethod(repoA: githubrepository, repoB: githubrepository) {
      const dateA = Date.parse(repoA.created_at)
      const dateB = Date.parse(repoB.created_at)

      return dateB - dateA
    }

    const repos: githubrepository[] = await (
      await fetch(githubUrl!)
    ).json()

    const validRepos = (
      await Promise.all(
        repos
          .map(async (repo) => {
            if(!repo) return null
            if(!repo.owner?.login || repo.name === repo.owner?.login) return null
            if(!repo.tags_url) return null
    
            const repoTags: repositoryTagsResponse = await (
              await fetch(repo.tags_url)
            ).json()
    
            if(repoTags.find((tag) => tag.name === "portfolio_repo")) return repo
    
            return null
          })
      )
    )
    .filter((repo) => repo ? repo : false)
    .sort(sortMethod as any) as githubrepository[]

    setRepos(validRepos)
  }, [githubUrl])

  useEffect(() => {
    getRepos()
  }, [getRepos])

  return (
    <Layout>
      <Head>
        <title>Pedro Barboza - Portfolio</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header />
      <About />
      <ProjectsSection
        heading="ExperiÃªncia profissional"
        hideExceededContent={false}
      >
        <TextCard
          heading={irbano.heading}
          text={[irbano.text]}
        />
      </ProjectsSection>
      {!repos || repos.length < 1 ? null : (
        <ProjectsSection
          heading="Projetos pessoais"
          isContentHidden={isHidden}
          hideExceededContent={true}
          setIsHidden={() => setIsHidden((prevState) => !prevState)}
        >
          {repos.map((item, index) => {
            const { name, description = "", homepage, html_url } = item

            return (
              <TextCard
                heading={name}
                text={[description]}
                githubLink={html_url}
                deployLink={homepage}
                key={`github-repository-${index}`}
              />
            )
          })}
        </ProjectsSection>
      )}
      <StudiesSection />
      <Footer />
    </Layout>
  )
}

export default Home
